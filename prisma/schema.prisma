generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  nickname      String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  avatarUrl     String?
  password      String?
  role          UserRole  @default(STUDENT)
  
  // Gamification fields
  xp            Int       @default(0)
  coins         Int       @default(0)
  level         Int       @default(1)
  streak        Int       @default(0)
  lastActivity  DateTime?
  
  accounts      Account[]
  sessions      Session[]
  progress      UserProgress[]
  attempts      ExerciseAttempt[]
  lessons       Lesson[]
  classesTaught Classroom[]            @relation("ClassroomTeacher")
  classMemberships ClassEnrollment[]
  assignmentsCreated HomeworkAssignment[] @relation("AssignmentCreator")
  assignmentTargets HomeworkAssignmentTarget[]
  spacedTopics  StudentSpacedTopic[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model KnowledgePoint {
  id                String   @id
  title             String
  description       String
  layer             Int
  prerequisites     String[] // Array of KP IDs
  interferenceLinks Json?    // { topicId: string, reason: string }[]
  encompassedSkills Json?    // { skillDescription: string }[]
  
  exercises         Exercise[]
  progress          UserProgress[]
  lessons           Lesson[]
  assignments       HomeworkAssignment[]
  spacedTopics      StudentSpacedTopic[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model UserProgress {
  id               String   @id @default(cuid())
  userId           String
  knowledgePointId String
  status           ProgressStatus @default(LOCKED)
  masteryLevel     Float    @default(0) // 0-100
  lastPracticed    DateTime?
  
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  knowledgePoint   KnowledgePoint @relation(fields: [knowledgePointId], references: [id], onDelete: Cascade)
  
  @@unique([userId, knowledgePointId])
}

model Exercise {
  id               String   @id @default(cuid())
  knowledgePointId String
  question         String
  answer           String
  hint             String?
  difficulty       Int      @default(1) // 1-4
  
  knowledgePoint   KnowledgePoint @relation(fields: [knowledgePointId], references: [id], onDelete: Cascade)
  attempts         ExerciseAttempt[]
  assignmentItems  HomeworkAssignmentExercise[]
  
  createdAt        DateTime @default(now())
}

model ExerciseAttempt {
  id          String   @id @default(cuid())
  userId      String
  exerciseId  String
  assignmentId String?
  answer      String
  isCorrect   Boolean
  xpEarned    Int      @default(0)
  coinsEarned Int      @default(0)
  timeSpent   Int?     // seconds
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise    Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  assignment  HomeworkAssignment? @relation(fields: [assignmentId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime @default(now())
}

enum ProgressStatus {
  LOCKED
  AVAILABLE
  IN_PROGRESS
  MASTERED
}

model Lesson {
  id               String   @id @default(cuid())
  title            String
  description      String
  knowledgePointId String
  teacherId        String
  inClassTimerMinutes Int @default(15)
  passThresholdPercent Int @default(70)
  lastSuccessPercent Float?
  
  knowledgePoint   KnowledgePoint @relation(fields: [knowledgePointId], references: [id], onDelete: Cascade)
  teacher          User           @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  slides           Slide[]
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Slide {
  id        String   @id @default(cuid())
  lessonId  String
  type      SlideType @default(content)
  title     String
  content   String   @db.Text
  order     Int      @default(0)
  
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@index([lessonId, order])
}

enum SlideType {
  content
  example
  exercise
  summary
}

model Classroom {
  id        String   @id @default(cuid())
  name      String
  teacherId String
  teacher   User     @relation("ClassroomTeacher", fields: [teacherId], references: [id], onDelete: Cascade)
  enrollments ClassEnrollment[]
  assignments HomeworkAssignment[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teacherId, name])
}

model ClassEnrollment {
  id         String   @id @default(cuid())
  classroomId String
  studentId  String
  classroom  Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  student    User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([classroomId, studentId])
}

model HomeworkAssignment {
  id                 String   @id @default(cuid())
  title              String
  description        String?
  teacherId          String
  classId            String?
  knowledgePointId   String
  dueDate            DateTime
  exerciseCount      Int      @default(5)
  subtopics          Json?
  spacedLearningEnabled Boolean @default(false)
  teacher            User     @relation("AssignmentCreator", fields: [teacherId], references: [id], onDelete: Cascade)
  classroom          Classroom? @relation(fields: [classId], references: [id], onDelete: SetNull)
  knowledgePoint     KnowledgePoint @relation(fields: [knowledgePointId], references: [id], onDelete: Cascade)
  items              HomeworkAssignmentExercise[]
  targets            HomeworkAssignmentTarget[]
  attempts           ExerciseAttempt[]
  spacedTopics       StudentSpacedTopic[]
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model HomeworkAssignmentExercise {
  id            String   @id @default(cuid())
  assignmentId  String
  exerciseId    String
  assignment    HomeworkAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  exercise      Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())

  @@unique([assignmentId, exerciseId])
}

model HomeworkAssignmentTarget {
  id             String   @id @default(cuid())
  assignmentId   String
  studentId      String
  status         AssignmentStatus @default(ASSIGNED)
  progressPct    Float    @default(0)
  attemptCount   Int      @default(0)
  assignedAt     DateTime @default(now())
  completedAt    DateTime?
  assignment     HomeworkAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student        User     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, studentId])
}

model StudentSpacedTopic {
  id                String   @id @default(cuid())
  studentId         String
  knowledgePointId  String
  sourceAssignmentId String?
  nextDueAt         DateTime @default(now())
  intervalDays      Int      @default(2)
  active            Boolean  @default(true)
  student           User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  knowledgePoint    KnowledgePoint @relation(fields: [knowledgePointId], references: [id], onDelete: Cascade)
  sourceAssignment  HomeworkAssignment? @relation(fields: [sourceAssignmentId], references: [id], onDelete: SetNull)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([studentId, knowledgePointId])
}

enum AssignmentStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  OVERDUE
}
